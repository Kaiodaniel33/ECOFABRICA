<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoF√°brica Consciente - Gest√£o Estrat√©gica</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           VIRTUAL FILE: /css/core/_variables.css
           DESCRI√á√ÉO: Tokens de design (Cores, Fontes, Sombras)
           ========================================================================== */
        :root {
            /* PROFESSOR SABI√Å: 
                Vari√°veis CSS (Custom Properties) s√£o nosso painel de controle.
                Mude a cor aqui em '--color-primary' e o site inteiro muda junto!
            */
            
            /* Paleta Principal */
            --color-primary-dark: #225c51;
            --color-primary: #2c786c;
            --color-primary-light: #4a7c59;
            --color-primary-extralight: #e8f5e9;

            /* Paleta de Feedback (A√ß√£o do Usu√°rio) */
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-danger: #f44336;
            --color-info: #2196f3;
            --color-research: #673ab7; /* Roxo para P&D */

            /* Paleta Neutra (Texto e Fundos) */
            --color-text-primary: #212121;
            --color-text-secondary: #5f6368;
            --color-text-light: #ffffff;
            --color-border: #e0e0e0;
            --color-disabled: #bdbdbd;
            --color-background-main: #f4f7f6;
            --color-background-container: #ffffff;
            --color-background-modal: rgba(0, 0, 0, 0.65); /* Mais escuro */
            --color-background-mentor: #fffbeb;

            /* Tipografia */
            --font-family-body: 'Roboto', 'Segoe UI', Tahoma, sans-serif;
            --font-family-heading: 'Poppins', sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;

            /* UI */
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --border-radius-large: 12px;
            --shadow-light: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-heavy: 0 8px 24px rgba(0,0,0,0.15);
            --transition-speed: 0.2s ease-in-out;
            --transition-speed-fast: 0.1s ease-in-out;
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/core/_reset.css
           DESCRI√á√ÉO: Normaliza estilos padr√µes do navegador.
           ========================================================================== */
        *,
        *::before,
        *::after {
            box-sizing: border-box; 
            /* PROFESSOR SABI√Å: 
                'box-sizing: border-box' √© obrigat√≥rio.
                Faz o 'padding' (espa√ßamento interno) e a 'border' (borda)
                serem inclu√≠dos na altura e largura total do elemento.
                Isso salva MUITA dor de cabe√ßa no layout.
            */
        }
        
        html { font-size: var(--font-size-base); }

        body {
            font-family: var(--font-family-body);
            line-height: var(--line-height-base);
            color: var(--color-text-primary);
            background-color: var(--color-background-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/core/_typography.css
           DESCRI√á√ÉO: Estilos base de texto (T√≠tulos, par√°grafos)
           ========================================================================== */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-family-heading);
            color: var(--color-primary-dark);
            margin: 0 0 0.75em 0;
            line-height: 1.2;
        }
        h1 { font-size: 2.25rem; }
        h2 { font-size: 1.75rem; color: var(--color-primary); }
        h3 { font-size: 1.25rem; color: var(--color-primary-light); }
        h4 { 
            font-size: 1.1rem; 
            color: var(--color-text-primary);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 8px;
            margin-top: 24px;
            text-align: left;
        }
        
        p { margin: 0 0 1em 0; }
        small { font-size: 0.85em; color: var(--color-text-secondary); }

        /* ==========================================================================
           VIRTUAL FILE: /css/layout/_main.css
           DESCRI√á√ÉO: Estilos de layout (Container, Grid)
           ========================================================================== */
        
        .l-game-wrapper {
            background-color: var(--color-background-container);
            padding: 25px 30px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            width: 100%;
            max-width: 1100px;
            position: relative;
            border-top: 5px solid var(--color-primary);
        }

        /* Layout das colunas de A√ß√µes e P&D */
        .l-columns {
            display: grid;
            /* PROFESSOR SABI√Å: 
                'grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))'
                Isso √© CSS Grid moderno! Significa: crie colunas que
                tenham NO M√çNIMO 300px. Se couber mais de uma (auto-fit),
                distribua o espa√ßo restante igualmente (1fr).
                Isso √© responsividade autom√°tica!
            */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            text-align: left;
            margin-top: 20px;
        }

        .l-credits-footer {
            margin-top: 25px;
            text-align: center;
            font-size: 0.8em;
            color: var(--color-text-secondary);
            border-top: 1px solid var(--color-border);
            padding-top: 15px;
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/components/_button.css
           DESCRI√á√ÉO: Estilos para TODOS os bot√µes
           ========================================================================== */
        
        /* Base do Bot√£o */
        .c-btn {
            font-family: var(--font-family-body);
            font-weight: 700;
            font-size: 1rem;
            color: var(--color-text-light);
            background-color: var(--color-primary-light);
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-speed);
            display: inline-block;
        }

        .c-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .c-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .c-btn:disabled {
            background-color: var(--color-disabled) !important;
            color: var(--color-text-secondary) !important;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        
        /* Modificadores de Cor */
        .c-btn--start { background-color: var(--color-success); }
        .c-btn--next-month { background-color: var(--color-warning); color: var(--color-text-primary); }
        .c-btn--decision { background-color: var(--color-info); }
        .c-btn--research { background-color: var(--color-research); }
        .c-btn--event { background-color: var(--color-primary-dark); }
        .c-btn--profile { background-color: var(--color-primary-light); }
        .c-btn--profile.is-selected {
            background-color: var(--color-primary-dark);
            transform: scale(1.03);
            box-shadow: var(--shadow-medium);
        }

        /* Modificadores de Layout */
        .c-btn--full-width {
            display: block;
            width: 100%;
            margin: 10px 0;
        }
        
        .c-btn--action {
            display: block;
            width: 100%;
            margin: 8px 0;
            text-align: left;
            padding: 10px 15px;
            border-left: 4px solid transparent;
            transition: all var(--transition-speed-fast);
        }
        /* MELHORIA: Feedback visual melhorado */
        .c-btn--action:hover:not(:disabled) {
            background-color: var(--color-primary-extralight);
            color: var(--color-primary-dark);
            border-left: 4px solid var(--color-primary);
            transform: translateX(3px);
            box-shadow: none;
        }
        .c-btn--research:hover:not(:disabled) {
            background-color: #ede7f6; /* Roxo claro */
            color: var(--color-research);
            border-left: 4px solid var(--color-research);
        }

        .c-btn--action small {
            display: block;
            font-weight: 400;
            opacity: 0.9;
            color: inherit; /* Herda a cor (branco ou escuro) */
            font-size: 0.85em;
        }
        .c-btn--action .cost { color: var(--color-warning); font-weight: 700; }
        .c-btn--action .rp { color: #d1c4e9; font-weight: 700; }
        .c-btn--action:hover:not(:disabled) .cost { color: var(--color-danger); }
        .c-btn--action:hover:not(:disabled) .rp { color: var(--color-research); }
        
        .c-btn--audio-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            font-size: 1.5em;
            padding: 0;
            line-height: 1;
            border-radius: 50%;
            background-color: var(--color-primary-light);
            z-index: 10;
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/components/_stats-grid.css
           DESCRI√á√ÉO: O painel principal de estat√≠sticas do jogo
           ========================================================================== */
        .c-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--color-primary-extralight);
            border-radius: var(--border-radius-medium);
        }

        .c-stats-grid__item {
            padding: 12px;
            background-color: var(--color-background-container);
            border-radius: var(--border-radius-small);
            font-size: 0.95em;
            border: 1px solid var(--color-border);
            text-align: left;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-speed);
        }

        /* MELHORIA: Feedback visual */
        .c-stats-grid__item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .c-stats-grid__label {
            display: block;
            font-size: 0.85em;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }
        
        .c-stats-grid__value {
            font-weight: 700;
            color: var(--color-primary-dark);
            font-size: 1.25em;
        }

        /* Modificadores de cor para valores espec√≠ficos */
        .c-stats-grid__value--budget { color: var(--color-success); }
        .c-stats-grid__value--waste { color: var(--color-danger); }
        .c-stats-grid__value--morale { color: var(--color-info); }
        .c-stats-grid__value--reputation { color: var(--color-primary-light); }
        .c-stats-grid__value--marketPriceModifier.is-good { color: var(--color-success); }
        .c-stats-grid__value--marketPriceModifier.is-bad { color: var(--color-danger); }


        /* ==========================================================================
           VIRTUAL FILE: /css/components/_log.css
           DESCRI√á√ÉO: O log de eventos do jogo
           ========================================================================== */
        .c-game-log {
            margin-top: 20px;
            padding: 15px;
            background-color: #fdfdfd;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-medium);
            text-align: left;
            height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .c-game-log__entry {
            margin: 0 0 8px 0;
            padding: 8px;
            border-bottom: 1px dashed var(--color-border);
        }
        .c-game-log__entry:first-child { 
            animation: fadeIn 0.5s ease;
        }
        .c-game-log__entry:last-child { border-bottom: none; }

        /* Modificadores de tipo de log */
        .c-game-log__entry--good { color: var(--color-success); }
        .c-game-log__entry--bad { color: var(--color-danger); }
        .c-game-log__entry--neutral { color: var(--color-info); }
        .c-game-log__entry--sabia { 
            font-style: italic; 
            color: var(--color-primary-dark);
            background-color: var(--color-primary-extralight);
            border-radius: var(--border-radius-small);
        }
        .c-game-log__entry--sabia strong { color: var(--color-primary); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/components/_forms.css
           DESCRI√á√ÉO: Estilos para inputs e labels
           ========================================================================== */
        .c-form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .c-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--color-primary-light);
            font-size: 1.1em;
        }

        .c-form-group input[type="text"] {
            padding: 12px;
            width: 100%;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-medium);
            font-size: 1rem;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        
        .c-form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-extralight);
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/components/_modal.css
           DESCRI√á√ÉO: Estilos para pop-ups (Relat√≥rio, Eventos, Professor)
           ========================================================================== */
        .c-modal {
            display: none; /* Controlado por JS */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--color-background-modal);
            animation: fadeIn 0.3s;
        }

        .c-modal__content {
            background-color: var(--color-background-container);
            margin: 10% auto;
            padding: 30px;
            border: 1px solid var(--color-border);
            width: 90%;
            max-width: 700px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-heavy);
            position: relative;
            animation: slideIn 0.4s;
        }

        .c-modal__close-btn {
            color: var(--color-text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color var(--transition-speed);
        }
        .c-modal__close-btn:hover,
        .c-modal__close-btn:focus {
            color: var(--color-text-primary);
            text-decoration: none;
            outline: none;
        }
        
        /* Modificador para o modal do Professor */
        .c-modal__content--sabia { border-top: 5px solid var(--color-warning); }
        .c-modal__content--sabia h2 { color: var(--color-warning); }
        
        .c-modal__content--event { border-top: 5px solid var(--color-danger); }
        .c-modal__content--event h2 { color: var(--color-danger); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/components/_chart.css
           DESCRI√á√ÉO: Estilos para o gr√°fico de barras do relat√≥rio
           ========================================================================== */
        .c-chart-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 250px;
            border-bottom: 2px solid var(--color-text-primary);
            padding: 10px;
            box-sizing: border-box;
            margin-top: 20px;
        }
        
        .c-chart-bar-wrapper {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            margin: 0 5px;
            flex-grow: 1;
            text-align: center;
        }

        .c-chart-bar {
            width: 100%;
            max-width: 40px; /* Largura m√°xima da barra */
            text-align: center;
            color: var(--color-text-light);
            font-size: 0.9em;
            position: relative;
            transition: height 0.5s ease-out;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 5px;
            box-sizing: border-box;
            border-radius: var(--border-radius-small) var(--border-radius-small) 0 0;
        }

        .c-chart-bar__value {
            font-weight: bold;
            background: rgba(0,0,0,0.2);
            padding: 1px 3px;
            border-radius: var(--border-radius-small);
        }

        .c-chart-bar__label {
            margin-top: 8px;
            color: var(--color-text-primary);
            font-size: 0.85em;
            font-weight: 700;
        }

        .c-chart-bar--budget { background-color: var(--color-success); }
        .c-chart-bar--sustainability { background-color: var(--color-primary); }
        .c-chart-bar--waste { background-color: var(--color-danger); }

        /* ==========================================================================
           VIRTUAL FILE: /css/components/_professor-sabia.css
           DESCRI√á√ÉO: Estilos para a UI do Professor Sabi√°
           ========================================================================== */
        .c-sabia-mentor {
            padding: 15px;
            margin-top: 20px;
            background-color: var(--color-background-mentor);
            border: 1px solid var(--color-warning);
            border-radius: var(--border-radius-medium);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-light);
        }

        .c-sabia-mentor__icon {
            font-size: 2.5em;
            flex-shrink: 0;
        }

        .c-sabia-mentor__content h4 {
            margin: 0 0 5px 0;
            color: var(--color-warning);
            border-bottom: none;
            font-size: 1.1em;
        }

        .c-sabia-mentor__content p {
            margin: 0;
            font-size: 0.95em;
            color: var(--color-text-secondary);
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/layout/_responsive.css
           DESCRI√á√ÉO: Media Queries para responsividade
           ========================================================================== */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .l-game-wrapper { padding: 15px; }
            
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }

            .l-columns {
                grid-template-columns: 1fr; /* For√ßa uma coluna √∫nica */
            }

            .c-stats-grid {
                grid-template-columns: 1fr 1fr; /* For√ßa duas colunas */
            }

            .c-modal__content {
                width: 95%;
                margin: 15% auto;
                padding: 20px;
            }

            .c-sabia-mentor {
                flex-direction: column;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .c-stats-grid {
                grid-template-columns: 1fr; /* For√ßa uma coluna √∫nica em telas muito pequenas */
            }
            .c-chart-bar__value { font-size: 0.7em; }
            .c-chart-bar__label { font-size: 0.7em; }
        }

        /* ==========================================================================
           VIRTUAL FILE: /css/utils/_helpers.css
           DESCRI√á√ÉO: Classes utilit√°rias (ex: esconder/mostrar)
           ========================================================================== */
        .u-hidden {
            display: none !important;
        }
        
        .u-text-danger { color: var(--color-danger); }
        .u-text-success { color: var(--color-success); }
        .u-text-center { text-align: center; }

    </style>
</head>
<body>
    <audio id="background-music" src="https://www.chosic.com/wp-content/uploads/2021/04/And-So-It-Begins-Inspired-By-Crush-Sometimes.mp3" loop></audio>

    <main class="l-game-wrapper">
        <header class="l-game-header">
            <button id="music-toggle" class="c-btn c-btn--audio-toggle" aria-label="Ativar ou desativar m√∫sica">üéµ</button>
            <h1 class="u-text-center">EcoF√°brica Consciente</h1>
            <h2 id="game-header" class="u-text-center">Gest√£o Estrat√©gica</h2>
        </header>
        
        <section id="start-screen">
            <div class="c-form-group">
                <label for="player-name-input">Nome do(a) Gestor(a):</label>
                <input type="text" id="player-name-input" placeholder="Digite seu nome aqui">
            </div>
            
            <div id="profile-selection">
                <h4>Escolha seu Perfil de Gest√£o:</h4>
                <button class="c-btn c-btn--profile c-btn--full-width" data-profile="visionario">
                    <strong>üåé Vision√°rio Verde</strong>
                    <small>Meta: Maximizar Sustentabilidade (100) e Reputa√ß√£o (90).</small>
                </button>
                <button class="c-btn c-btn--profile c-btn--full-width" data-profile="capitalista">
                    <strong>üí∞ Capitalista Consciente</strong>
                    <small>Meta: Maximizar o Lucro (R$ 5000) e Sustentabilidade (60).</small>
                </button>
                <button class="c-btn c-btn--profile c-btn--full-width" data-profile="lider">
                    <strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ L√≠der Comunit√°rio</strong>
                    <small>Meta: Maximizar a Moral da Equipe (100) e Reputa√ß√£o (95).</small>
                </button>
            </div>
            <button id="start-button" class="c-btn c-btn--start c-btn--full-width" disabled>Aceitar o Desafio e Iniciar Gest√£o!</button>
        </section>

        <section id="game-screen" class="u-hidden">
            <div id="stats-grid" class="c-stats-grid"></div>

            <aside id="sabia-mentor-ui" class="c-sabia-mentor">
                <div class="c-sabia-mentor__icon">ü¶â</div>
                <div class="c-sabia-mentor__content">
                    <h4 id="sabia-tip-title">Dica do Professor Sabi√°</h4>
                    <p id="sabia-tip-text">Bem-vindo(a)! Preste aten√ß√£o nas suas m√©tricas. O equil√≠brio √© a chave!</p>
                </div>
            </aside>
            
            <div class="l-columns">
                <div id="decisions-column">
                    </div>
                <div id="research-column">
                    <h4>Pesquisa & Desenvolvimento (P&D)</h4>
                    </div>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button id="show-report-button" class="c-btn">Ver Relat√≥rio de Desempenho</button>
                <button id="next-month-button" class="c-btn c-btn--next-month c-btn--full-width">Avan√ßar para Pr√≥ximo M√™s</button>
            </div>

            <h4>Log de Eventos</h4>
            <div id="game-log" class="c-game-log"></div>
        </section>

        <section id="end-screen" class="u-hidden u-text-center">
            <h2>Fim do Ciclo de Gest√£o!</h2>
            <p>Confira o desempenho final da sua ECOF√ÅBRICA CONSCIENTE:</p>
            <div id="final-stats-grid" class="c-stats-grid"></div>
            <p id="final-message" style="font-size: 1.2em; font-weight: bold;"></p>
            <button id="restart-button" class="c-btn c-btn--start c-btn--full-width">Iniciar Nova Gest√£o (Recarregar)</button>
        </section>

        <footer class="l-credits-footer">
            <p><strong>Desenvolvimento do Conceito e Jogo Base:</strong> Kaio Daniel de Souza da Costa (1¬∫ A), Lucas Raczenski Marques (2¬∫ A), Murilo Silvestre Bernardes (2¬∫ A), Marielly (2¬∫ A), Stefany (2¬∫ A), Lucas Gabriel Kruger Avelino (2¬∫ A)</p>
            <p>C.E. PROFESSOR IVONE SOARES CASTANHARO | <strong>Professor Monitor Orientador:</strong> Felipe Oliveira TI</p>
        </footer>
    </main>

    <div id="report-modal" class="c-modal" role="dialog" aria-modal="true" aria-labelledby="report-modal-title">
        <div class="c-modal__content">
            <span class="c-modal__close-btn" data-modal-id="report-modal">&times;</span>
            <h2 id="report-modal-title">Relat√≥rio de Desempenho</h2>
            <p>Evolu√ß√£o mensal das suas principais m√©tricas:</p>
            <div id="chart-container" class="c-chart-container">
                </div>
            <div style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 0.9em;">
                <span><span style="color:var(--color-success)">‚ñ†</span> Or√ßamento</span>
                <span><span style="color:var(--color-primary)">‚ñ†</span> Sustentabilidade</span>
                <span><span style="color:var(--color-danger)">‚ñ†</span> Desperd√≠cio</span>
            </div>
        </div>
    </div>
    
    <div id="event-modal" class="c-modal" role="dialog" aria-modal="true" aria-labelledby="event-modal-title">
        <div class="c-modal__content c-modal__content--event">
            <span class="c-modal__close-btn u-hidden">&times;</span> <h2 id="event-modal-title">Acontecimento!</h2>
            <p id="event-modal-message">Uma situa√ß√£o inesperada ocorreu!</p>
            <div id="event-modal-choices">
                </div>
        </div>
    </div>
    
    <div id="sabia-quiz-modal" class="c-modal" role="dialog" aria-modal="true" aria-labelledby="sabia-quiz-title">
        <div class="c-modal__content c-modal__content--sabia">
            <span class="c-modal__close-btn" data-modal-id="sabia-quiz-modal">&times;</span>
            <h2 id="sabia-quiz-title">ü¶â Pergunta do Professor Sabi√°!</h2>
            <p>Vamos testar seu conhecimento de c√≥digo, jovem aprendiz!</p>
            <p id="sabia-quiz-question" style="font-weight: 700; font-size: 1.1em;"></p>
            <div id="sabia-quiz-choices">
                </div>
            <p id="sabia-quiz-feedback" style="margin-top: 15px;"></p>
        </div>
    </div>


    <script>
    /*
    PROFESSOR SABI√Å: 
    'document.addEventListener("DOMContentLoaded", ...)'
    Isso diz ao navegador: "Ei, n√£o execute NENHUM JavaScript
    at√© que todo o HTML da p√°gina esteja carregado e pronto."
    √â a nossa "luz verde" para come√ßar!
    */
    document.addEventListener("DOMContentLoaded", () => {

        /* ==========================================================================
           VIRTUAL FILE: /js/utils/helpers.js
           DESCRI√á√ÉO: Fun√ß√µes utilit√°rias puras e reutiliz√°veis.
           ========================================================================== */
        const Helpers = {
            /** Formata um n√∫mero como moeda BRL (Real) */
            formatCurrency: (value) => {
                // PROFESSOR SABI√Å: 'Intl.NumberFormat' √© a forma moderna
                // de formatar moedas, sem gambiarras.
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(value || 0);
            },

            /** Limita um n√∫mero a um intervalo (m√≠nimo e m√°ximo) */
            clamp: (value, min, max) => {
                // PROFESSOR SABI√Å: 'clamp' (trava) √© super √∫til para
                // garantir que a 'Moral' n√£o passe de 100.
                return Math.max(min, Math.min(value, max));
            },
            
            /** Pega um item aleat√≥rio de um array */
            getRandomItem: (arr) => {
                if (!arr || arr.length === 0) return null;
                return arr[Math.floor(Math.random() * arr.length)];
            }
        };


        /* ==========================================================================
           VIRTUAL FILE: /js/config/SabiaData.js
           DESCRI√á√ÉO: A "Intelig√™ncia" do Professor Sabi√°.
                      Base de conhecimento sobre o jogo e c√≥digo.
           ========================================================================== */
        const SABIA_KNOWLEDGE_BASE = {
            // Dicas contextuais sobre o JOGO
            gameTips: [
                { 
                    condition: (s) => s.budget < 500,
                    tip: "Seu or√ßamento est√° perigosamente baixo! Evite gastos grandes e foque em a√ß√µes que gerem receita ou reduzam custos, como 'Otimizar Log√≠stica'." 
                },
                { 
                    condition: (s) => s.waste > 60,
                    tip: "O n√≠vel de desperd√≠cio est√° alt√≠ssimo! Isso gera custos e afeta sua reputa√ß√£o. Invista em 'Reciclagem B√°sica' ou 'Treinamento de Efici√™ncia' urgente!" 
                },
                { 
                    condition: (s) => s.morale < 40,
                    tip: "A moral da equipe est√° em queda. Funcion√°rios infelizes produzem menos. Considere 'Melhorar refeit√≥rio' ou uma Pol√≠tica de 'Lanches Gr√°tis'." 
                },
                { 
                    condition: (s) => s.sustainability < 20,
                    tip: "Sua opera√ß√£o n√£o √© nada sustent√°vel. A fiscaliza√ß√£o pode bater na sua porta. 'Investir em Energia Solar' √© caro, mas resolve isso a longo prazo."
                },
                { 
                    condition: (s) => s.researchPoints > 15,
                    tip: "Voc√™ acumulou muitos Pontos de P&D! N√£o os deixe parados. Pesquise novas tecnologias para desbloquear a√ß√µes mais poderosas."
                },
                { 
                    condition: (s) => s.marketPriceModifier > 1.3,
                    tip: `O mercado est√° pagando ${((s.marketPriceModifier-1)*100).toFixed(0)}% a mais! Sua produ√ß√£o vale ouro! Excelente hora para focar em 'Produ√ß√£o'.`
                },
                { 
                    condition: (s) => s.marketPriceModifier < 0.9,
                    tip: "O mercado est√° em baixa... Estamos recebendo menos pelos produtos. Talvez seja hora de focar em cortar custos e desperd√≠cio, em vez de expandir a produ√ß√£o."
                },
                { 
                    condition: (s) => s.currentMonth === 1,
                    tip: "Primeiro m√™s! Analise seu perfil de gestor. Se voc√™ √© 'Vision√°rio Verde', sua prioridade √© Sustentabilidade, n√£o apenas lucro." 
                },
                { 
                    condition: (s) => s.currentMonth === 6,
                    tip: "Estamos no meio do ano. √â um bom momento para checar o Relat√≥rio de Desempenho e ver sua evolu√ß√£o. Ajuste sua estrat√©gia!" 
                },
                {
                    condition: (s) => s.currentMonth === 11,
                    tip: "Reta final! Se voc√™ est√° longe da sua meta, talvez precise de uma a√ß√£o de 'alto risco, alta recompensa'. Boa sorte!"
                }
            ],
            
            // Perguntas do Quiz sobre C√ìDIGO (HTML, CSS, JS)
            quizQuestions: [
                {
                    area: "HTML",
                    question: "Qual tag HTML √© usada para o *conte√∫do principal* de uma p√°gina, ajudando na sem√¢ntica e acessibilidade?",
                    options: ["<div class='main'>", "<main>", "<content>", "<body-content>"],
                    answer: "<main>",
                    explanation: "<main> √© a tag sem√¢ntica correta. Leitores de tela usam ela para pular direto ao conte√∫do principal."
                },
                {
                    area: "HTML",
                    question: "Para que serve o atributo 'for' em uma tag <label>?",
                    options: ["Para criar um loop 'for'", "Para conectar o label a um 'id' de um <input>", "Para definir a fonte do texto", "Para uso em formul√°rios de 'for'necedores"],
                    answer: "Para conectar o label a um 'id' de um <input>",
                    explanation: "O 'for' no <label> √© vinculado ao 'id' do <input>, melhorando a acessibilidade e a usabilidade (clicar no label foca o input)."
                },
                {
                    area: "HTML",
                    question: "O que significa o atributo 'data-profile' que usamos nos bot√µes de perfil?",
                    options: ["Define o CSS do perfil", "√â um atributo de dados ('data attribute') para guardar informa√ß√µes customizadas", "√â um link para o perfil do usu√°rio", "N√£o tem fun√ß√£o, √© apenas um coment√°rio"],
                    answer: "√â um atributo de dados ('data attribute') para guardar informa√ß√µes customizadas",
                    explanation: "Data attributes (come√ßam com 'data-') s√£o uma forma padr√£o de armazenar dados no HTML para serem lidos pelo JavaScript."
                },
                {
                    area: "CSS",
                    question: "O que 'box-sizing: border-box;' faz?",
                    options: ["Coloca uma borda em todas as caixas", "Calcula o tamanho da caixa incluindo padding e border na largura/altura total", "Calcula o tamanho da caixa somando padding e border √† largura/altura", "Centraliza a caixa na p√°gina"],
                    answer: "Calcula o tamanho da caixa incluindo padding e border na largura/altura total",
                    explanation: "Por padr√£o, 'width' + 'padding' + 'border' = largura real. Com 'border-box', 'width' = largura real (incluindo padding/border). Isso facilita layouts!"
                },
                {
                    area: "CSS",
                    question: "Qual a *vantagem* de usar Vari√°veis CSS (ex: '--color-primary')?",
                    options: ["Deixa o CSS mais r√°pido", "√â a √∫nica forma de usar cores", "Permite mudar um valor (ex: uma cor) em um s√≥ lugar e atualizar o site inteiro", "Funciona em navegadores antigos como o IE6"],
                    answer: "Permite mudar um valor (ex: uma cor) em um s√≥ lugar e atualizar o site inteiro",
                    explanation: "Vari√°veis centralizam seus valores de design ('tokens'). Mude a vari√°vel '--color-primary' e todos os elementos que a usam mudam instantaneamente."
                },
                {
                    area: "CSS",
                    question: "No CSS Grid, o que 'repeat(auto-fit, minmax(200px, 1fr))' significa?",
                    options: ["Cria 200 colunas", "Repete o layout 1 vez", "Cria colunas de 200px que n√£o crescem", "Cria o m√°ximo de colunas que couberem, com no m√≠nimo 200px, e distribui o espa√ßo extra (1fr)"],
                    answer: "Cria o m√°ximo de colunas que couberem, com no m√≠nimo 200px, e distribui o espa√ßo extra (1fr)",
                    explanation: "√â uma das regras mais poderosas do CSS Grid para criar layouts responsivos automaticamente, sem precisar de media queries!"
                },
                {
                    area: "JS",
                    question: "O que o 'document.addEventListener(\"DOMContentLoaded\", ...)' faz?",
                    options: ["Inicia o download do HTML", "Espera o DOM (HTML) estar totalmente carregado antes de rodar o JS", "Carrega as fontes do documento", "Cria um evento de clique"],
                    answer: "Espera o DOM (HTML) estar totalmente carregado antes de rodar o JS",
                    explanation: "Isso previne erros! Se o JS rodar antes do HTML, ele pode tentar achar um bot√£o (ex: 'start-button') que *ainda n√£o existe* e quebrar."
                },
                {
                    area: "JS",
                    question: "Qual a diferen√ßa entre 'let' e 'const'?",
                    options: ["'let' √© para n√∫meros, 'const' √© para texto", "'let' pode ter seu valor reatribu√≠do, 'const' n√£o pode", "'const' √© mais r√°pido que 'let'", "N√£o h√° diferen√ßa, s√£o a mesma coisa"],
                    answer: "'let' pode ter seu valor reatribu√≠do, 'const' n√£o pode",
                    explanation: "'const' (constante) cria uma vari√°vel que n√£o pode ser reatribu√≠da. 'let' cria uma vari√°vel que pode. Regra de ouro: use 'const' sempre, a menos que voc√™ *precise* mudar o valor, a√≠ use 'let'."
                },
                {
                    area: "JS",
                    question: "Para que serve a 'Intl.NumberFormat('pt-BR', ...)' que usamos?",
                    options: ["Para formatar n√∫meros internacionais", "Para formatar n√∫meros e moedas no padr√£o correto de uma l√≠ngua (ex: R$ 1.234,56)", "Para traduzir a p√°gina", "Para calcular impostos"],
                    answer: "Para formatar n√∫meros e moedas no padr√£o correto de uma l√≠ngua (ex: R$ 1.234,56)",
                    explanation: "'Intl' (Internationalization) √© a API nativa do JS para lidar com formatos de data, hora e n√∫meros em diferentes locais do mundo."
                },
                {
                    area: "JS",
                    question: "O que √© uma 'Classe' (como 'class Game' que usamos)?",
                    options: ["Um arquivo de CSS", "Uma 'planta' ou 'molde' para criar objetos com as mesmas propriedades e m√©todos", "Uma fun√ß√£o que roda sozinha", "Um tipo de coment√°rio"],
                    answer: "Uma 'planta' ou 'molde' para criar objetos com as mesmas propriedades e m√©todos",
                    explanation: "A 'class Game' √© o molde. Quando fazemos 'new Game()', criamos um *objeto* (uma 'inst√¢ncia') daquele molde, que j√° vem com 'state', 'ui', 'sabia', e os m√©todos 'advanceMonth()', etc."
                },
                {
                    area: "JS",
                    question: "Por que separamos o c√≥digo em classes como 'Game', 'State' e 'UI'?",
                    options: ["Porque √© obrigat√≥rio pelo navegador", "Para o c√≥digo ficar mais longo", "Chama-se 'Separa√ß√£o de Preocupa√ß√µes' (SoC). Cada classe tem UMA responsabilidade, facilitando a manuten√ß√£o.", "Para confundir quem est√° lendo"],
                    answer: "Chama-se 'Separa√ß√£o de Preocupa√ß√µes' (SoC). Cada classe tem UMA responsabilidade, facilitando a manuten√ß√£o.",
                    explanation: "A 'UI' s√≥ mexe no HTML. A 'State' s√≥ guarda dados. O 'Game' orquestra tudo. Se o layout quebrar, mexemos s√≥ na 'UI'. Se o c√°lculo de lucro estiver errado, mexemos s√≥ na 'State'. Isso √© arquitetura s√≥lida!"
                }
            ]
        };


        /* ==========================================================================
           VIRTUAL FILE: /js/config/GameData.js
           DESCRI√á√ÉO: A defini√ß√£o de TODO o conte√∫do do jogo.
                      EXPANDIDO com novas categorias, a√ß√µes e eventos.
           ========================================================================== */
        const GAME_DATA = {
            totalMonths: 12,
            
            initialState: {
                budget: 1500,
                production: 50,
                waste: 40,
                sustainability: 20,
                morale: 60,
                reputation: 30,
                researchPoints: 5,
                land: 10,
                marketPriceModifier: 1.0, // 1.0 = 100% do pre√ßo
            },
            
            statDisplayNames: {
                budget: "Or√ßamento",
                production: "Produ√ß√£o/m√™s",
                waste: "Desperd√≠cio/m√™s",
                sustainability: "Sustentabilidade",
                morale: "Moral da Equipe",
                reputation: "Reputa√ß√£o",
                researchPoints: "Pontos P&D",
                land: "√Årea Agr√≠cola (ha)",
                marketPriceModifier: "Pre√ßo de Mercado"
            },
            
            profiles: {
                visionario: {
                    name: "Vision√°rio Verde üåé",
                    description: "Sua gest√£o foi um exemplo para o Paran√°! Voc√™ provou que √© poss√≠vel prosperar cuidando do planeta.",
                    winCondition: (s) => s.sustainability >= 100 && s.reputation >= 90,
                    getWinMessage: (s) => `PARAB√âNS! Voc√™ atingiu ${s.sustainability} de Sustentabilidade e ${s.reputation} de Reputa√ß√£o!`
                },
                capitalista: {
                    name: "Capitalista Consciente üí∞",
                    description: "Resultados financeiros impressionantes! Voc√™ soube aliar lucro com responsabilidade.",
                    winCondition: (s) => s.budget >= 5000 && s.sustainability >= 60,
                    getWinMessage: (s) => `PARAB√âNS! Voc√™ atingiu ${Helpers.formatCurrency(s.budget)} em caixa e ${s.sustainability} de Sustentabilidade!`
                },
                lider: {
                    name: "L√≠der Comunit√°rio üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
                    description: "Sua f√°brica √© o orgulho da comunidade! Sua gest√£o focada em pessoas e reputa√ß√£o criou um ambiente exemplar.",
                    winCondition: (s) => s.morale >= 100 && s.reputation >= 95,
                    getWinMessage: (s) => `PARAB√âNS! Voc√™ atingiu ${s.morale} de Moral e ${s.reputation} de Reputa√ß√£o!`
                }
            },
            
            // √Årvore de Pesquisa (P&D) - Expandida
            researchTree: {
                // Tier 1: Pesquisas B√°sicas
                t1_basic_recycling: {
                    id: 't1_basic_recycling',
                    label: "P&D: Reciclagem B√°sica",
                    costRP: 5,
                    description: "Estuda m√©todos simples de separa√ß√£o e reuso de res√≠duos.",
                    effects: { sustainability: 5 },
                    unlocksActions: ['action_implement_basic_recycling', 'action_policy_preventive_maintenance'],
                    requiredTech: []
                },
                t1_efficiency_studies: {
                    id: 't1_efficiency_studies',
                    label: "P&D: Estudos de Efici√™ncia",
                    costRP: 5,
                    description: "Analisa o fluxo de trabalho para reduzir desperd√≠cio de tempo e material.",
                    effects: { production: 5 },
                    unlocksActions: ['action_team_training_efficiency', 'action_policy_overtime'],
                    requiredTech: []
                },
                t1_local_marketing: {
                    id: 't1_local_marketing',
                    label: "P&D: Marketing Comunit√°rio",
                    costRP: 3,
                    description: "Entende como melhorar a imagem da f√°brica na comunidade local.",
                    effects: { reputation: 5 },
                    unlocksActions: ['action_sponsor_local_team', 'action_community_open_day'],
                    requiredTech: []
                },
                
                // Tier 2: Pesquisas Intermedi√°rias
                t2_water_optimization: {
                    id: 't2_water_optimization',
                    label: "P&D: Otimiza√ß√£o de √Ågua",
                    costRP: 10,
                    description: "Pesquisa sobre reuso de √°gua e sistemas de irriga√ß√£o eficientes.",
                    effects: { sustainability: 5 },
                    unlocksActions: ['action_install_water_reuse_system'],
                    requiredTech: ['t1_basic_recycling']
                },
                t2_green_energy: {
                    id: 't2_green_energy',
                    label: "P&D: Estudo de Energia Limpa",
                    costRP: 12,
                    description: "Analisa a viabilidade de pain√©is solares e outras fontes limpas.",
                    effects: {},
                    unlocksActions: ['action_install_solar_panels'],
                    requiredTech: ['t1_efficiency_studies']
                },
                t2_hr_development: {
                    id: 't2_hr_development',
                    label: "P&D: Desenvolvimento de RH",
                    costRP: 8,
                    description: "Estuda pol√≠ticas de b√¥nus, sa√∫de e bem-estar para a equipe.",
                    effects: { morale: 5 },
                    unlocksActions: ['action_profit_sharing_plan', 'action_health_plan'],
                    requiredTech: ['t1_local_marketing']
                },
                t2_supply_chain: {
                    id: 't2_supply_chain',
                    label: "P&D: Log√≠stica de Suprimentos",
                    costRP: 10,
                    description: "Otimiza a compra de mat√©ria-prima e log√≠stica de entrada.",
                    effects: {},
                    unlocksActions: ['action_local_suppliers'],
                    requiredTech: ['t1_efficiency_studies']
                },

                // Tier 3: Pesquisas Avan√ßadas
                t3_advanced_recycling: {
                    id: 't3_advanced_recycling',
                    label: "P&D: Reciclagem Avan√ßada",
                    costRP: 20,
                    description: "Desenvolve tecnologia para 'lixo zero', transformando res√≠duos em sub-produtos.",
                    effects: { sustainability: 10 },
                    unlocksActions: ['action_zero_waste_plant'],
                    requiredTech: ['t2_water_optimization']
                },
                t3_automation: {
                    id: 't3_automation',
                    label: "P&D: Automa√ß√£o de Linha",
                    costRP: 25,
                    description: "Implementa rob√¥s para acelerar a produ√ß√£o (cuidado com a moral!).",
                    effects: { production: 10 },
                    unlocksActions: ['action_automate_production_line'],
                    requiredTech: ['t2_green_energy']
                },
                t3_brand_strategy: {
                    id: 't3_brand_strategy',
                    label: "P&D: Estrat√©gia de Marca",
                    costRP: 15,
                    description: "Cria uma marca forte e reconhecida nacionalmente.",
                    effects: { reputation: 10 },
                    unlocksActions: ['action_national_marketing_campaign'],
                    requiredTech: ['t2_hr_development']
                },
                
                // Tier 4: Pesquisas de Ponta
                t4_carbon_capture: {
                    id: 't4_carbon_capture',
                    label: "P&D: Captura de Carbono",
                    costRP: 40,
                    description: "Tecnologia experimental para tornar a f√°brica carbono-negativo.",
                    effects: { sustainability: 20 },
                    unlocksActions: ['action_carbon_capture_filters'],
                    requiredTech: ['t3_advanced_recycling']
                },
                t4_ai_optimization: {
                    id: 't4_ai_optimization',
                    label: "P&D: Otimiza√ß√£o por IA",
                    costRP: 35,
                    description: "Usa IA para prever demanda de mercado e otimizar a produ√ß√£o em tempo real.",
                    effects: { production: 10 },
                    unlocksActions: ['action_ai_logistics'],
                    requiredTech: ['t3_automation']
                }
            },
            
            // A√ß√µes de Gest√£o (Agora com "category")
            actions: {
                // Categoria: Opera√ß√µes
                action_optimize_logistics: {
                    id: 'action_optimize_logistics',
                    category: 'Opera√ß√µes',
                    label: "Otimizar Log√≠stica de Entrega",
                    cost: 200,
                    description: "Revisar rotas de entrega para economizar combust√≠vel e tempo.",
                    effects: {},
                    isMonthlyEffect: true,
                    monthlyEffects: { budget_income: 50, sustainability: 1 },
                    requiredTech: []
                },
                action_implement_basic_recycling: {
                    id: 'action_implement_basic_recycling',
                    category: 'Opera√ß√µes',
                    label: "Implementar Reciclagem B√°sica",
                    cost: 300,
                    description: "Instala lixeiras de separa√ß√£o e processos de reuso.",
                    effects: { waste: -15, sustainability: 15, morale: 5 },
                    requiredTech: ['t1_basic_recycling']
                },
                action_install_water_reuse_system: {
                    id: 'action_install_water_reuse_system',
                    category: 'Opera√ß√µes',
                    label: "Instalar Reuso de √Ågua",
                    cost: 600,
                    description: "Sistema de ciclo fechado que economiza milhares de litros.",
                    effects: { waste: -10, sustainability: 20 },
                    requiredTech: ['t2_water_optimization']
                },
                action_install_solar_panels: {
                    id: 'action_install_solar_panels',
                    category: 'Opera√ß√µes',
                    label: "Instalar Energia Solar (Pequena)",
                    cost: 1000,
                    description: "Cobre 30% da demanda de energia com pain√©is solares.",
                    effects: { sustainability: 30, reputation: 10, waste: -5 },
                    monthlyEffects: { budget_income: 100 },
                    requiredTech: ['t2_green_energy']
                },
                action_local_suppliers: {
                    id: 'action_local_suppliers',
                    category: 'Opera√ß√µes',
                    label: "Priorizar Fornecedores Locais",
                    cost: 250,
                    description: "Reduz custo de frete e melhora a reputa√ß√£o local.",
                    effects: { reputation: 10, sustainability: 5 },
                    monthlyEffects: { budget_income: 25 },
                    requiredTech: ['t2_supply_chain']
                },
                action_zero_waste_plant: {
                    id: 'action_zero_waste_plant',
                    category: 'Opera√ß√µes',
                    label: "Converter para 'Lixo Zero'",
                    cost: 2500,
                    description: "Investimento massivo para eliminar 100% do desperd√≠cio.",
                    effects: { waste: -50, sustainability: 40, reputation: 20 },
                    requiredTech: ['t3_advanced_recycling']
                },
                action_automate_production_line: {
                    id: 'action_automate_production_line',
                    category: 'Opera√ß√µes',
                    label: "Automatizar Linha de Produ√ß√£o",
                    cost: 2000,
                    description: "Aumenta drasticamente a produ√ß√£o, mas pode reduzir a moral.",
                    effects: { production: 50, morale: -20, waste: 5 },
                    requiredTech: ['t3_automation']
                },
                action_carbon_capture_filters: {
                    id: 'action_carbon_capture_filters',
                    category: 'Opera√ß√µes',
                    label: "Instalar Filtros de Captura de Carbono",
                    cost: 3000,
                    description: "Torna a f√°brica carbono-negativo, um feito de RP e sustentabilidade.",
                    effects: { sustainability: 50, reputation: 30 },
                    monthlyEffects: { budget_expense: 100 },
                    requiredTech: ['t4_carbon_capture']
                },
                action_ai_logistics: {
                    id: 'action_ai_logistics',
                    category: 'Opera√ß√µes',
                    label: "Implementar Log√≠stica por IA",
                    cost: 1500,
                    description: "IA otimiza toda a cadeia de suprimentos, reduzindo custos.",
                    effects: { production: 10 },
                    monthlyEffects: { budget_income: 150, waste: -5 },
                    requiredTech: ['t4_ai_optimization']
                },
                
                // Categoria: Recursos Humanos
                action_improve_breakroom: {
                    id: 'action_improve_breakroom',
                    category: 'Recursos Humanos',
                    label: "Melhorar Refeit√≥rio",
                    cost: 150,
                    description: "Caf√© de melhor qualidade e um espa√ßo mais confort√°vel.",
                    effects: { morale: 10, waste: 1 },
                    requiredTech: []
                },
                action_team_training_efficiency: {
                    id: 'action_team_training_efficiency',
                    category: 'Recursos Humanos',
                    label: "Capacitar Equipe (Efici√™ncia)",
                    cost: 250,
                    description: "Treinamento para reduzir desperd√≠cio na linha de produ√ß√£o.",
                    effects: { production: 10, morale: 10, waste: -5 },
                    requiredTech: ['t1_efficiency_studies']
                },
                action_profit_sharing_plan: {
                    id: 'action_profit_sharing_plan',
                    category: 'Recursos Humanos',
                    label: "Plano de Participa√ß√£o nos Lucros",
                    cost: 500,
                    description: "Divide uma pequena parte dos lucros com a equipe.",
                    effects: { morale: 25, production: 5 },
                    monthlyEffects: { budget_expense: 150 },
                    requiredTech: ['t2_hr_development']
                },
                action_health_plan: {
                    id: 'action_health_plan',
                    category: 'Recursos Humanos',
                    label: "Oferecer Plano de Sa√∫de B√°sico",
                    cost: 300,
                    description: "Plano de sa√∫de para todos os funcion√°rios.",
                    effects: { morale: 20 },
                    monthlyEffects: { budget_expense: 75 },
                    requiredTech: ['t2_hr_development']
                },

                // Categoria: Agr√≠cola
                action_buy_more_land: {
                    id: 'action_buy_more_land',
                    category: 'Agr√≠cola',
                    label: "Comprar Mais Terra (5ha)",
                    cost: 300,
                    description: "Expande a √°rea agr√≠cola, aumentando o potencial de produ√ß√£o.",
                    effects: { land: 5, production: 5, waste: 2 },
                    requiredTech: []
                },
                action_protect_from_frost: {
                    id: 'action_protect_from_frost',
                    category: 'Agr√≠cola',
                    label: "Instalar Estufas Protetoras",
                    cost: 400,
                    description: "Protege a planta√ß√£o de geadas, reduzindo perdas.",
                    effects: { sustainability: 5 },
                    unlocksFlag: 'frostProtection', // Flag para evento
                    requiredTech: []
                },

                // Categoria: Comunidade
                action_sponsor_local_team: {
                    id: 'action_sponsor_local_team',
                    category: 'Comunidade',
                    label: "Patrocinar Time Local",
                    cost: 200,
                    description: "Coloca o logo da f√°brica na camiseta do time de futebol da cidade.",
                    effects: { morale: 5, reputation: 15 },
                    requiredTech: ['t1_local_marketing']
                },
                action_community_open_day: {
                    id: 'action_community_open_day',
                    category: 'Comunidade',
                    label: "Dia de F√°brica Aberta",
                    cost: 100,
                    description: "Convida a comunidade para visitar a f√°brica.",
                    effects: { reputation: 10 },
                    requiredTech: ['t1_local_marketing']
                },
                action_national_marketing_campaign: {
                    id: 'action_national_marketing_campaign',
                    category: 'Comunidade',
                    label: "Campanha de Marketing Nacional",
                    cost: 1500,
                    description: "Torna a 'EcoF√°brica' uma marca reconhecida no Brasil.",
                    effects: { reputation: 30 },
                    monthlyEffects: { marketPriceModifier: 0.2 },
                    requiredTech: ['t3_brand_strategy']
                },

                // NOVA CATEGORIA: Pol√≠ticas (T√™m custos recorrentes)
                action_policy_snacks: {
                    id: 'action_policy_snacks',
                    category: 'Pol√≠ticas',
                    label: "Pol√≠tica: Lanches Gr√°tis",
                    cost: 100, // Custo de implementa√ß√£o
                    description: "Implementa lanches. Custo recorrente de $50/m√™s.",
                    effects: { morale: 5 },
                    monthlyEffects: { budget_expense: 50 },
                    requiredTech: []
                },
                action_policy_overtime: {
                    id: 'action_policy_overtime',
                    category: 'Pol√≠ticas',
                    label: "Pol√≠tica: Horas Extras Pagas",
                    cost: 0, 
                    description: "Aumenta a produ√ß√£o. Custo recorrente de $100/m√™s.",
                    effects: { production: 10, morale: -5 }, // Efeito imediato
                    monthlyEffects: { budget_expense: 100, production: 5, morale: -2 }, // Efeito recorrente
                    requiredTech: ['t1_efficiency_studies']
                },
                action_policy_preventive_maintenance: {
                    id: 'action_policy_preventive_maintenance',
                    category: 'Pol√≠ticas',
                    label: "Pol√≠tica: Manuten√ß√£o Preventiva",
                    cost: 200, 
                    description: "Reduz o desperd√≠cio. Custo recorrente de $75/m√™s.",
                    effects: { waste: -5 },
                    monthlyEffects: { budget_expense: 75, waste: -3 },
                    requiredTech: ['t1_basic_recycling']
                }
            },
            
            // Eventos Aleat√≥rios (Mais variedade e bug de repeti√ß√£o corrigido)
            events: [
                // Eventos Negativos
                {
                    id: "GEADA",
                    title: "Alerta de Geada Severa!",
                    condition: (s) => (s.currentMonth === 6 || s.currentMonth === 7) && !s.unlockedFlags.frostProtection && Math.random() < 0.6,
                    message: "Uma frente fria intensa vinda do Sul amea√ßa congelar sua produ√ß√£o agr√≠cola. Suas planta√ß√µes est√£o vulner√°veis!",
                    choices: [
                        { text: "Sofrer o impacto total", effects: { production: -20, budget: -150 }, log: "A geada foi devastadora. Perdemos parte da produ√ß√£o." },
                        { text: "Tentar salvar parte (Gastar $100)", cost: 100, effects: { production: -10, budget: -50 }, log: "Conseguimos salvar parte da colheita, mas tivemos custos emergenciais." }
                    ]
                },
                {
                    id: "ESTIAGEM",
                    title: "Estiagem Severa!",
                    condition: (s) => (s.currentMonth === 1 || s.currentMonth === 2 || s.currentMonth === 11 || s.currentMonth === 12) && !s.unlockedTech.includes('t2_water_optimization') && Math.random() < 0.4,
                    message: "A falta de chuva no Paran√° est√° cr√≠tica, afetando o n√≠vel dos reservat√≥rios e sua produ√ß√£o.",
                    choices: [
                        { text: "Aceitar consequ√™ncias", effects: { production: -15, waste: 5, budget: -100 }, log: "A estiagem impactou a produ√ß√£o e aumentou os custos." }
                    ]
                },
                {
                    id: "FISCALIZACAO",
                    title: "Fiscaliza√ß√£o Ambiental!",
                    condition: (s) => s.waste > 50 && s.sustainability < 30 && Math.random() < 0.3,
                    message: "Fiscais do Instituto √Ågua e Terra (IAT) est√£o na f√°brica. Eles encontraram irregularidades no descarte de res√≠duos.",
                    choices: [
                        // AJUSTE: Removida op√ß√£o de suborno.
                        { text: "Pagar multa e se adequar ($300)", cost: 300, effects: { reputation: -10, sustainability: -5 }, log: "Multa paga. Tivemos que nos adequar √†s pressas." },
                        { text: "Negociar um Termo de Ajuste ($100)", cost: 100, effects: { reputation: -5 }, log: "Negociamos um TAC. A multa foi baixa, mas a reputa√ß√£o sofreu um pouco." }
                    ]
                },
                {
                    id: "EQUIPE_DOENTE",
                    title: "Surto de Gripe na Equipe",
                    condition: (s) => s.morale < 50 && !s.unlockedActions.includes('action_health_plan') && Math.random() < 0.3,
                    message: "Com a moral baixa e o inverno chegando, um surto de gripe afastou 15% da sua equipe.",
                    choices: [
                        { text: "Contratar tempor√°rios ($200)", cost: 200, effects: { production: -5, morale: -5 }, log: "Contratamos tempor√°rios, mas a produ√ß√£o caiu e a equipe ficou sobrecarregada." },
                        { text: "Absorver a perda", effects: { production: -15, morale: -10, budget: -50 }, log: "N√£o fizemos nada e a produ√ß√£o do m√™s foi muito prejudicada." }
                    ]
                },
                {
                    id: "PRAGA_LAVOURA",
                    title: "Praga na Lavoura!",
                    condition: (s) => s.land > 10 && Math.random() < 0.25,
                    message: "Uma praga de gafanhotos atingiu parte da sua √°rea agr√≠cola!",
                    choices: [
                        { text: "Contratar controle de pragas ($250)", cost: 250, effects: { production: -5, sustainability: -5 }, log: "O controle de pragas (com agrot√≥xicos) resolveu, mas afetou nossa sustentabilidade." },
                        { text: "Usar controle biol√≥gico ($400)", cost: 400, effects: { production: -5, sustainability: 5, reputation: 5 }, log: "O controle biol√≥gico foi caro, mas efetivo e melhorou nossa imagem." },
                        { text: "Ignorar e esperar", effects: { production: -25, budget: -100, land: -5 }, log: "A praga foi um desastre e perdemos 5 hectares de terra produtiva." }
                    ]
                },
                {
                    id: "MAQUINARIO_QUEBRADO",
                    title: "Maquin√°rio Essencial Quebrou!",
                    condition: (s) => s.production > 70 && !s.unlockedActions.includes('action_policy_preventive_maintenance') && Math.random() < 0.3,
                    message: "A principal linha de produ√ß√£o parou por falta de manuten√ß√£o! Precisamos de um reparo emergencial.",
                    choices: [
                        { text: "Reparo de Emerg√™ncia ($500)", cost: 500, effects: { production: -10, morale: -5 }, log: "O reparo foi caro e atrasou a produ√ß√£o do m√™s." },
                    ]
                },
                {
                    id: "FORNECEDOR_FALHA",
                    title: "Fornecedor de Mat√©ria-Prima Faliu!",
                    condition: (s) => s.currentMonth > 4 && !s.unlockedActions.includes('action_local_suppliers') && Math.random() < 0.2,
                    message: "Nosso principal fornecedor de mat√©ria-prima fechou as portas! Teremos que achar um substituto mais caro √†s pressas.",
                    choices: [
                        { text: "Pagar mais caro este m√™s ($300)", cost: 300, effects: { production: -5 }, log: "Achamos um substituto, mas o custo impactou o or√ßamento." }
                    ]
                },
                
                // Eventos Positivos
                {
                    id: "MIDIA_POSITIVA",
                    title: "Reportagem Local Positiva!",
                    condition: (s) => s.reputation > 60 && s.sustainability > 50 && Math.random() < 0.25,
                    message: "Um jornal local fez uma reportagem elogiando as pr√°ticas sustent√°veis da EcoF√°brica! O p√∫blico adorou.",
                    choices: [
                        { text: "Agradecer e continuar", effects: { reputation: 15, morale: 10, marketPriceModifier: 0.1 }, log: "A reportagem positiva aumentou nossa reputa√ß√£o e o pre√ßo dos produtos!" }
                    ]
                },
                {
                    id: "INOVACAO_INTERNA",
                    title: "Ideia Brilhante da Equipe!",
                    condition: (s) => s.morale > 75 && Math.random() < 0.2,
                    message: "Com a equipe motivada, um funcion√°rio sugeriu uma pequena mudan√ßa no processo que pode economizar muito!",
                    choices: [
                        { text: "Implementar e dar b√¥nus ($100)", cost: 100, effects: { morale: 10, researchPoints: 5, waste: -10 }, log: "A ideia foi um sucesso e a equipe se sente valorizada!" },
                        { text: "Implementar e ignorar o funcion√°rio", effects: { morale: -15, researchPoints: 5, waste: -10 }, log: "A ideia funcionou, mas a equipe ficou desmotivada por n√£o ser reconhecida." }
                    ]
                },
                {
                    id: "SAFRA_RECORDE",
                    title: "Safra Recorde!",
                    condition: (s) => (s.currentMonth === 3 || s.currentMonth === 4) && s.land > 10 && Math.random() < 0.2,
                    message: "O clima foi perfeito! Tivemos uma safra recorde, muito acima do esperado.",
                    choices: [
                        { text: "Vender o excedente (+$400)", cost: -400, effects: { production: 10, waste: 5 }, log: "Safra recorde! Ganhamos um b√¥nus de $400, mas parte se perdeu no armazenamento." }
                    ]
                },
                {
                    id: "FUNCIONARIO_DESTAQUE",
                    title: "Funcion√°rio Destaque",
                    condition: (s) => s.morale > 70 && s.unlockedActions.includes('action_team_training_efficiency') && Math.random() < 0.15,
                    message: "Um funcion√°rio treinado se destacou, otimizando sozinho uma pequena √°rea da f√°brica.",
                    choices: [
                        { text: "Promov√™-lo a supervisor ($150)", cost: 150, effects: { morale: 10, production: 10 }, monthlyEffects: { budget_expense: 50 }, log: "Novo supervisor! A equipe est√° motivada e a produ√ß√£o melhorou." },
                        { text: "Dar um b√¥nus √∫nico ($100)", cost: 100, effects: { morale: 5, production: 5 }, log: "O funcion√°rio ficou feliz com o b√¥nus." }
                    ]
                },
                {
                    id: "VISITA_ESCOLA",
                    title: "Escola Local Pede Visita",
                    condition: (s) => s.reputation > 40 && s.unlockedActions.includes('action_community_open_day') && Math.random() < 0.3,
                    message: "Uma escola local quer trazer os alunos para conhecerem a 'f√°brica ecol√≥gica' da cidade.",
                    choices: [
                        { text: "Aceitar e preparar tour ($50)", cost: 50, effects: { reputation: 10, morale: 5 }, log: "A visita foi um sucesso e os pais dos alunos elogiaram a iniciativa." },
                        { text: "Recusar (sem custo)", effects: { reputation: -5 }, log: "Recusamos a visita, o que gerou coment√°rios negativos na comunidade." }
                    ]
                }
            ]
        };


        /* ==========================================================================
           VIRTUAL FILE: /js/core/State.js
           DESCRI√á√ÉO: Classe que gerencia TODO o estado (dados) do jogo.
           ========================================================================== */
        
        // PROFESSOR SABI√Å: 
        // A classe 'GameState' √© o "Modelo" (o 'M' do MVC).
        // Ela √© o √öNICO lugar que sabe qual √© o seu or√ßamento.
        // √â a "fonte da verdade".
        
        class GameState {
            constructor() {
                this.currentState = { ...GAME_DATA.initialState };
                this.playerName = "Gestor(a)";
                this.managerProfile = null;
                this.currentMonth = 0;
                
                // Controles de Jogo
                this.isEventActive = false;
                this.unlockedTech = []; 
                this.unlockedActions = [];
                this.unlockedFlags = {};
                
                // CORRE√á√ÉO DO BUG: Lista de eventos que j√° ocorreram
                this.triggeredEvents = [];
                
                this.monthlyEffects = {
                    budget_income: 0,
                    budget_expense: 0,
                    marketPriceModifier: 0.0,
                    production: 0,
                    morale: 0,
                    waste: 0
                };
                
                this.history = {
                    budget: [],
                    sustainability: [],
                    waste: []
                };
            }
            
            /** Retorna o objeto de estado atual (imut√°vel) */
            get() {
                // PROFESSOR SABI√Å: 
                // Usamos '{ ...this.currentState }' (Spread Operator)
                // para enviar uma *c√≥pia* do estado. Isso evita que
                // outras partes do c√≥digo modifiquem o estado acidentalmente.
                return { 
                    ...this.currentState,
                    playerName: this.playerName,
                    managerProfile: this.managerProfile,
                    currentMonth: this.currentMonth,
                    unlockedTech: this.unlockedTech,
                    unlockedActions: this.unlockedActions,
                    unlockedFlags: this.unlockedFlags
                };
            }
            
            /** Inicia o estado do jogo com base na sele√ß√£o do jogador */
            initialize(playerName, profileId) {
                this.playerName = playerName || "Gestor(a) Consciente";
                this.managerProfile = profileId;
                this.currentState = { ...GAME_DATA.initialState };
                
                // Reset de vari√°veis de controle
                this.currentMonth = 0;
                this.isEventActive = false;
                this.unlockedTech = [];
                this.unlockedActions = [];
                this.unlockedFlags = {};
                this.triggeredEvents = []; // CORRE√á√ÉO: Limpa hist√≥rico de eventos
                this.monthlyEffects = {
                    budget_income: 0, budget_expense: 0, marketPriceModifier: 0.0,
                    production: 0, morale: 0, waste: 0
                };
                this.history = { budget: [], sustainability: [], waste: [] };

                // B√¥nus inicial baseado no perfil
                if (profileId === 'visionario') {
                    this.currentState.sustainability += 10;
                    this.currentState.researchPoints += 3;
                } else if (profileId === 'capitalista') {
                    this.currentState.budget += 300;
                } else if (profileId === 'lider') {
                    this.currentState.morale += 10;
                    this.currentState.reputation += 5;
                }
            }
            
            /** Marca um evento como "ocorrido" para evitar repeti√ß√£o */
            triggerEvent(eventId) {
                if (eventId && !this.triggeredEvents.includes(eventId)) {
                    this.triggeredEvents.push(eventId);
                }
            }
            
            /**
             * Aplica os efeitos de uma a√ß√£o ou P&D
             * @param {object} item - O objeto de A√ß√£o ou P&D
             */
            applyItemEffects(item) {
                const s = this.currentState;

                // 1. Custos
                if (item.cost) s.budget -= item.cost;
                if (item.costRP) s.researchPoints -= item.costRP;
                
                // 2. Efeitos Imediatos (ex: +10 moral)
                if (item.effects) {
                    for (const key in item.effects) {
                        s[key] = (s[key] || 0) + item.effects[key];
                    }
                }
                
                // 3. Efeitos Recorrentes (ex: +$50/m√™s)
                // MELHORIA: Agora suporta mais do que apenas or√ßamento
                if (item.monthlyEffects) {
                    for (const key in item.monthlyEffects) {
                        this.monthlyEffects[key] = (this.monthlyEffects[key] || 0) + item.monthlyEffects[key];
                    }
                }
                
                // 4. Desbloqueios
                if (item.id) {
                    if (item.costRP) this.unlockedTech.push(item.id);
                    else this.unlockedActions.push(item.id);
                }
                if (item.unlocksFlag) {
                    this.unlockedFlags[item.unlocksFlag] = true;
                }
                
                this.clampStats();
            }
            
            /** Aplica os efeitos da escolha de um evento */
            applyEventChoice(choice) {
                const s = this.currentState;
                if (choice.cost) s.budget -= choice.cost;
                if (choice.effects) {
                    for (const key in choice.effects) {
                        s[key] = (s[key] || 0) + choice.effects[key];
                    }
                }
                // Aplica efeitos recorrentes se o evento tiver
                if (choice.monthlyEffects) {
                     for (const key in choice.monthlyEffects) {
                        this.monthlyEffects[key] = (this.monthlyEffects[key] || 0) + choice.monthlyEffects[key];
                    }
                }
                this.clampStats();
            }

            /** A principal fun√ß√£o de c√°lculo do jogo. Roda a cada m√™s. */
            processMonthlyTurn() {
                this.currentMonth++;
                const s = this.currentState;
                
                // 1. Grava hist√≥rico (para o gr√°fico)
                this.history.budget.push(s.budget);
                this.history.sustainability.push(s.sustainability);
                this.history.waste.push(s.waste);

                // 2. Aplicar Efeitos Recorrentes (de Pol√≠ticas, etc)
                s.production += this.monthlyEffects.production;
                s.morale += this.monthlyEffects.morale;
                s.waste += this.monthlyEffects.waste;
                
                // 3. C√°lculo de Receita (Income)
                const basePrice = 15;
                // Flutua√ß√£o de Mercado
                s.marketPriceModifier = Helpers.clamp(s.marketPriceModifier + (Math.random() * 0.2 - 0.1), 0.7, 1.5);
                const marketMod = s.marketPriceModifier + this.monthlyEffects.marketPriceModifier;
                const premiumMod = 1 + (s.reputation / 200) + (s.sustainability / 250);
                const income = s.production * basePrice * marketMod * premiumMod;

                // 4. C√°lculo de Despesas (Expenses)
                const wasteCost = s.waste * 5;
                const productionCost = s.production * 3;
                const landCost = s.land * 5;
                const moraleCost = Math.max(0, (100 - s.morale) * 2);
                const expenses = wasteCost + productionCost + landCost + moraleCost;
                
                // 5. Aplicar custos/ganhos recorrentes
                const netMonthlyEffects = this.monthlyEffects.budget_income - this.monthlyEffects.budget_expense;
                
                // 6. Atualizar Or√ßamento
                const profit = income - expenses + netMonthlyEffects;
                s.budget += profit;
                
                // 7. Atualiza√ß√µes Passivas
                s.researchPoints += (s.morale > 75 ? 3 : (s.morale > 50 ? 2 : 1));
                s.morale += (Math.random() * 4 - 2); // Flutua√ß√£o
                s.reputation -= 1; // Reputa√ß√£o cai se n√£o for mantida
                
                // 8. Aplicar limites
                this.clampStats();
                
                return { income, expenses, netMonthlyEffects, profit };
            }
            
            /** Verifica se h√° um evento aleat√≥rio para este m√™s */
            checkForRandomEvent() {
                const s = this.get();
                
                const potentialEvents = GAME_DATA.events.filter(event => {
                    // CORRE√á√ÉO DO BUG:
                    // Adicionada a checagem '!this.triggeredEvents.includes(event.id)'
                    // para garantir que o evento s√≥ aconte√ßa uma vez.
                    return event.condition(s) && !this.triggeredEvents.includes(event.id);
                });
                
                if (potentialEvents.length > 0) {
                    return Helpers.getRandomItem(potentialEvents);
                }
                return null;
            }
            
            /** Garante que as estat√≠sticas fiquem entre 0 e 100 (ou mais) */
            clampStats() {
                const s = this.currentState;
                s.sustainability = Helpers.clamp(s.sustainability, 0, 100);
                s.morale = Helpers.clamp(s.morale, 0, 100);
                s.reputation = Helpers.clamp(s.reputation, 0, 100);
                s.waste = Math.max(0, s.waste);
                s.production = Math.max(0, s.production);
                s.researchPoints = Math.max(0, s.researchPoints);
                s.marketPriceModifier = Helpers.clamp(s.marketPriceModifier, 0.5, 2.0);
                s.budget = Math.round(s.budget);
            }
            
            /** Verifica a condi√ß√£o de vit√≥ria */
            checkWinCondition() {
                const profile = GAME_DATA.profiles[this.managerProfile];
                if (!profile) return false;
                return profile.winCondition(this.currentState);
            }
            
            /** Retorna a mensagem de vit√≥ria ou derrota */
            getFinalMessage(isBankruptcy) {
                if (isBankruptcy) {
                    return `Que pena... A ECOF√ÅBRICA faliu no M√™s ${this.currentMonth}. Mas n√£o desanime, toda jornada tem seus trope√ßos. Tente novamente!`;
                }
                
                const profile = GAME_DATA.profiles[this.managerProfile];
                const didWin = this.checkWinCondition();
                
                if (didWin) {
                    const winMsg = profile.getWinMessage(this.currentState);
                    return `PARAB√âNS, ${this.playerName}! Voc√™ atingiu sua meta como ${profile.name}! ${winMsg} ${profile.description}`;
                } else {
                    return `A gest√£o foi um grande aprendizado, ${this.playerName}. Voc√™ n√£o atingiu a meta de ${profile.name}, mas cada desafio ensina. Tente novamente!`;
                }
            }
        }


        /* ==========================================================================
           VIRTUAL FILE: /js/core/UI.js
           DESCRI√á√ÉO: Classe que gerencia TODA a intera√ß√£o com o DOM (HTML).
                      L√™ o estado e atualiza a tela. N√£o faz c√°lculos.
           ========================================================================== */
        
        // PROFESSOR SABI√Å: 
        // A classe 'GameUI' √© a "Vis√£o" (o 'V' do MVC).
        // Sua √∫nica tarefa √©: "Olhar para o objeto 'State' e desenhar a tela".
        // Ela n√£o sabe *por que* o or√ßamento mudou. Ela s√≥ v√™
        // 'state.budget = 500' e atualiza o HTML para 'R$ 500'.
        
        class GameUI {
            constructor() {
                // "Cache" de seletores do DOM.
                this.dom = {
                    startScreen: document.getElementById('start-screen'),
                    gameScreen: document.getElementById('game-screen'),
                    endScreen: document.getElementById('end-screen'),
                    gameHeader: document.getElementById('game-header'),
                    playerNameInput: document.getElementById('player-name-input'),
                    profileButtons: document.querySelectorAll('.c-btn--profile'),
                    startButton: document.getElementById('start-button'),
                    statsGrid: document.getElementById('stats-grid'),
                    decisionsColumn: document.getElementById('decisions-column'),
                    researchColumn: document.getElementById('research-column'),
                    nextMonthButton: document.getElementById('next-month-button'),
                    showReportButton: document.getElementById('show-report-button'),
                    gameLog: document.getElementById('game-log'),
                    sabiaMentorBox: document.getElementById('sabia-mentor-ui'),
                    sabiaTipTitle: document.getElementById('sabia-tip-title'),
                    sabiaTipText: document.getElementById('sabia-tip-text'),
                    finalStatsGrid: document.getElementById('final-stats-grid'),
                    finalMessage: document.getElementById('final-message'),
                    restartButton: document.getElementById('restart-button'),
                    reportModal: document.getElementById('report-modal'),
                    eventModal: document.getElementById('event-modal'),
                    sabiaQuizModal: document.getElementById('sabia-quiz-modal'),
                    closeModalButtons: document.querySelectorAll('.c-modal__close-btn'),
                    chartContainer: document.getElementById('chart-container'),
                    eventModalTitle: document.getElementById('event-modal-title'),
                    eventModalMessage: document.getElementById('event-modal-message'),
                    eventModalChoices: document.getElementById('event-modal-choices'),
                    sabiaQuizQuestion: document.getElementById('sabia-quiz-question'),
                    sabiaQuizChoices: document.getElementById('sabia-quiz-choices'),
                    sabiaQuizFeedback: document.getElementById('sabia-quiz-feedback'),
                    music: {
                        audio: document.getElementById('background-music'),
                        toggleBtn: document.getElementById('music-toggle')
                    }
                };
                
                this.isMusicPlaying = false;
            }
            
            /** Adiciona todos os event listeners da UI */
            bindEvents(gameInstance) {
                // PROFESSOR SABI√Å: 
                // A UI n√£o sabe o que 'handleAction' faz, ela s√≥
                // avisa o 'Game': "Ei, o usu√°rio clicou em uma a√ß√£o!".
                
                // Tela Inicial
                this.dom.profileButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.dom.profileButtons.forEach(btn => btn.classList.remove('is-selected'));
                        button.classList.add('is-selected');
                        this.dom.startButton.disabled = false;
                    });
                });
                
                this.dom.startButton.addEventListener('click', () => {
                    const name = this.dom.playerNameInput.value;
                    const profile = document.querySelector('.c-btn--profile.is-selected')?.dataset.profile;
                    if (profile) {
                        gameInstance.startGame(name, profile);
                    }
                });
                
                // Controles do Jogo
                this.dom.nextMonthButton.addEventListener('click', () => gameInstance.advanceMonth());
                this.dom.showReportButton.addEventListener('click', () => gameInstance.showReport());
                this.dom.restartButton.addEventListener('click', () => window.location.reload());
                
                // Listeners de A√ß√£o e P&D (Usando Delega√ß√£o de Evento)
                // PROFESSOR SABI√Å: 
                // "Delega√ß√£o de Evento" √© uma t√©cnica PRO.
                // Adicionamos UM listener no "pai" (a coluna) em vez de 30
                // nos bot√µes. √â muito mais perform√°tico!
                this.dom.decisionsColumn.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action-id]');
                    if (button && !button.disabled) {
                        gameInstance.handleAction(button.dataset.actionId);
                    }
                });
                
                this.dom.researchColumn.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-research-id]');
                    if (button && !button.disabled) {
                        gameInstance.handleResearch(button.dataset.researchId);
                    }
                });

                // Modais
                this.dom.closeModalButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const modalId = btn.dataset.modalId;
                        if (modalId) {
                            this.showModal(modalId, false);
                        }
                    });
                });
                
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('c-modal')) {
                        const modalId = event.target.id;
                        if (modalId !== 'event-modal') {
                            this.showModal(modalId, false);
                        }
                    }
                });
                
                // Controle de M√∫sica
                this.dom.music.toggleBtn.addEventListener('click', () => this.toggleMusic());
            }

            /** Alterna entre telas (start, game, end) */
            switchScreen(screenName) {
                this.dom.startScreen.classList.add('u-hidden');
                this.dom.gameScreen.classList.add('u-hidden');
                this.dom.endScreen.classList.add('u-hidden');
                
                if (screenName === 'game') {
                    this.dom.gameScreen.classList.remove('u-hidden');
                } else if (screenName === 'end') {
                    this.dom.endScreen.classList.remove('u-hidden');
                } else {
                    this.dom.startScreen.classList.remove('u-hidden');
                }
            }
            
            /** Toca ou pausa a m√∫sica de fundo */
            toggleMusic(forcePlay = false) {
                if (forcePlay && !this.isMusicPlaying) {
                    this.dom.music.audio.volume = 0.2;
                    this.dom.music.audio.play().catch(e => console.warn("M√∫sica aguardando intera√ß√£o do usu√°rio."));
                    this.dom.music.toggleBtn.textContent = 'üéµ';
                    this.isMusicPlaying = true;
                } else if (!forcePlay) {
                    if (this.dom.music.audio.paused) {
                        this.dom.music.audio.play();
                        this.dom.music.toggleBtn.textContent = 'üéµ';
                        this.isMusicPlaying = true;
                    } else {
                        this.dom.music.audio.pause();
                        this.dom.music.toggleBtn.textContent = 'üîá';
                        this.isMusicPlaying = false;
                    }
                }
            }

            /** A principal fun√ß√£o de renderiza√ß√£o. Chamada todo m√™s. */
            render(state, history, isEventActive) {
                // 1. Renderiza Cabe√ßalho
                this.dom.gameHeader.innerHTML = `Gestor(a) <strong>${state.playerName}</strong> - M√™s: <strong>${state.currentMonth}</strong> / ${GAME_DATA.totalMonths}`;
                
                // 2. Renderiza Stats
                this.renderStats(state, this.dom.statsGrid);
                
                // 3. Renderiza A√ß√µes e P&D
                this.renderActions(state);
                this.renderResearch(state);
                
                // 4. Atualiza estado dos bot√µes
                this.updateButtonStates(state, isEventActive);
            }
            
            /** Renderiza o grid de estat√≠sticas */
            renderStats(state, targetElement) {
                targetElement.innerHTML = ''; // Limpa o grid
                const displayNames = GAME_DATA.statDisplayNames;
                
                Object.keys(displayNames).forEach(key => {
                    if (state.hasOwnProperty(key)) {
                        const name = displayNames[key];
                        const value = state[key];
                        let valueStr = "";
                        let modifierClass = `c-stats-grid__value--${key}`;
                        
                        // Formata√ß√£o especial
                        if (key === 'budget') {
                            valueStr = Helpers.formatCurrency(value);
                        } else if (key === 'marketPriceModifier') {
                            valueStr = `${(value * 100).toFixed(0)}%`;
                            // Adiciona classe de cor para mercado
                            if(value > 1.1) modifierClass += ' is-good';
                            if(value < 0.9) modifierClass += ' is-bad';
                        } else if (key.match(/sustainability|morale|reputation/)) {
                            valueStr = `${value.toFixed(0)} / 100`;
                        } else {
                            valueStr = value.toFixed(0);
                        }
                        
                        // Cria√ß√£o do HTML
                        const statItem = document.createElement('div');
                        statItem.className = 'c-stats-grid__item';
                        
                        statItem.innerHTML = `
                            <span class="c-stats-grid__label">${name}</span>
                            <span class="c-stats-grid__value ${modifierClass}">${valueStr}</span>
                        `;
                        targetElement.appendChild(statItem);
                    }
                });
            }
            
            /** * MELHORIA: Renderiza os bot√µes de A√ß√µes, agrupados por categoria.
             * Isso √© muito mais organizado e escal√°vel.
             */
            renderActions(state) {
                this.dom.decisionsColumn.innerHTML = ''; // Limpa a coluna
                
                // 1. Agrupar a√ß√µes por categoria
                const categories = {};
                Object.values(GAME_DATA.actions).forEach(action => {
                    // Verifica se j√° foi comprada (se n√£o for mensal/recorrente)
                    if (!action.isMonthlyEffect && state.unlockedActions.includes(action.id)) return;
                    
                    // Verifica se tem a P&D necess√°ria
                    const hasTech = action.requiredTech.every(techId => state.unlockedTech.includes(techId));
                    if (!hasTech) return; // Esconde o bot√£o

                    // Adiciona ao grupo
                    const cat = action.category || 'Outras';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(action);
                });
                
                // 2. Renderizar por categoria
                const categoryOrder = ['Opera√ß√µes', 'Recursos Humanos', 'Agr√≠cola', 'Comunidade', 'Pol√≠ticas', 'Outras'];
                
                categoryOrder.forEach(catName => {
                    if (categories[catName]) {
                        // Adiciona o T√≠tulo da Categoria (H4)
                        const h4 = document.createElement('h4');
                        h4.textContent = catName;
                        this.dom.decisionsColumn.appendChild(h4);
                        
                        // Adiciona os bot√µes da categoria
                        categories[catName].forEach(action => {
                            this.dom.decisionsColumn.appendChild(
                                this.createActionButton(action, 'action', state)
                            );
                        });
                    }
                });
            }
            
            /** Renderiza os bot√µes de P&D (Pesquisa) */
            renderResearch(state) {
                this.dom.researchColumn.innerHTML = '<h4>Pesquisa & Desenvolvimento (P&D)</h4>';
                
                Object.values(GAME_DATA.researchTree).forEach(tech => {
                    if (state.unlockedTech.includes(tech.id)) return;
                    
                    const hasRequiredTech = tech.requiredTech.every(reqId => state.unlockedTech.includes(reqId));
                    if (!hasRequiredTech) return;
                    
                    this.dom.researchColumn.appendChild(
                        this.createActionButton(tech, 'research', state)
                    );
                });
            }
            
            /** Fun√ß√£o auxiliar para criar bot√µes de a√ß√£o/P&D */
            createActionButton(item, type, state) {
                const button = document.createElement('button');
                const isResearch = type === 'research';
                
                button.dataset[isResearch ? 'researchId' : 'actionId'] = item.id;
                button.className = `c-btn c-btn--action ${isResearch ? 'c-btn--research' : 'c-btn--decision'}`;
                
                const cost = item.cost || 0;
                const costRP = item.costRP || 0;
                
                // Verifica custos
                let reason = "";
                if (state.budget < cost) reason = "Or√ßamento insuficiente";
                else if (state.researchPoints < costRP) reason = "P&D insuficiente";
                
                button.disabled = reason !== "";
                button.title = reason || item.description;
                
                // Descri√ß√£o de custos
                let costStr = '';
                if(cost > 0) costStr += `<span class="cost">${Helpers.formatCurrency(cost)}</span>`;
                if(costRP > 0) costStr += ` / <span class="rp">${costRP} P&D</span>`;
                if(costStr === '') costStr = 'Gr√°tis';

                // Descri√ß√£o de Custo Recorrente (para Pol√≠ticas)
                let monthlyCostStr = '';
                if(item.monthlyEffects && item.monthlyEffects.budget_expense > 0) {
                    monthlyCostStr = ` (Recorrente: ${Helpers.formatCurrency(item.monthlyEffects.budget_expense)}/m√™s)`;
                }

                // PROFESSOR SABI√Å: 
                // 'Template Literals' (o texto com `...`)
                // nos deixam injetar vari√°veis (ex: ${item.label})
                // diretamente na string.
                
                button.innerHTML = `
                    <strong>${item.label}</strong>
                    <small>
                        ${item.description}
                        <br>
                        Custo: ${costStr}${monthlyCostStr}
                    </small>
                `;
                return button;
            }
            
            /** Atualiza o estado de bot√µes (ex: "Pr√≥ximo M√™s") */
            updateButtonStates(state, isEventActive) {
                this.dom.nextMonthButton.disabled = isEventActive;
                this.dom.showReportButton.disabled = isEventActive;
                
                // Desabilita todos os bot√µes de a√ß√£o/P&D se um evento estiver ativo
                this.dom.decisionsColumn.querySelectorAll('button').forEach(b => {
                    if (isEventActive) b.disabled = true;
                });
                this.dom.researchColumn.querySelectorAll('button').forEach(b => {
                    if (isEventActive) b.disabled = true;
                });
            }

            /** Adiciona uma entrada ao Log de Eventos na tela */
            addLog(message, type = 'neutral') {
                const p = document.createElement('p');
                p.innerHTML = message;
                p.className = `c-game-log__entry c-game-log__entry--${type}`;
                this.dom.gameLog.prepend(p);
            }
            
            /** Atualiza a caixa de dicas do Professor Sabi√° */
            updateSabiaTip(title, text) {
                this.dom.sabiaTipTitle.textContent = title;
                this.dom.sabiaTipText.textContent = text;
                this.dom.sabiaMentorBox.style.animation = 'none';
                void this.dom.sabiaMentorBox.offsetWidth; // Truque para reiniciar a anima√ß√£o
                this.dom.sabiaMentorBox.style.animation = 'fadeIn 0.5s';
            }

            /** Mostra ou esconde um modal */
            showModal(modalId, show = true) {
                const modal = this.dom[modalId];
                if (modal) {
                    modal.style.display = show ? 'block' : 'none';
                }
            }
            
            /** Preenche e mostra o modal de Evento */
            showEventModal(event, choiceCallback) {
                this.dom.eventModalTitle.textContent = event.title;
                this.dom.eventModalMessage.textContent = event.message;
                this.dom.eventModalChoices.innerHTML = '';
                
                event.choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'c-btn c-btn--event c-btn--full-width';
                    button.textContent = choice.text;
                    button.onclick = () => {
                        choiceCallback(index); // Avisa ao 'Game' qual escolha foi feita
                        this.showModal('eventModal', false);
                    };
                    this.dom.eventModalChoices.appendChild(button);
                });
                
                this.showModal('eventModal', true);
            }
            
            /** Preenche e mostra o modal de Quiz do Sabi√° */
            showSabiaQuizModal(quiz, answerCallback) {
                this.dom.sabiaQuizQuestion.textContent = quiz.question;
                this.dom.sabiaQuizChoices.innerHTML = '';
                this.dom.sabiaQuizFeedback.innerHTML = '';
                
                const options = [...quiz.options].sort(() => Math.random() - 0.5);
                
                options.forEach(optionText => {
                    const button = document.createElement('button');
                    button.className = 'c-btn c-btn--decision c-btn--full-width';
                    button.textContent = optionText;
                    button.onclick = () => {
                        const isCorrect = (optionText === quiz.answer);
                        this.dom.sabiaQuizFeedback.innerHTML = isCorrect ?
                            `<span class="u-text-success"><strong>Correto!</strong> ${quiz.explanation}</span>` :
                            `<span class="u-text-danger"><strong>Quase!</strong> A resposta correta √© <strong>${quiz.answer}</strong>. ${quiz.explanation}</span>`;
                        
                        this.dom.sabiaQuizChoices.querySelectorAll('button').forEach(b => b.disabled = true);
                        answerCallback(isCorrect);
                    };
                    this.dom.sabiaQuizChoices.appendChild(button);
                });
                
                this.showModal('sabiaQuizModal', true);
            }

            /** Renderiza o gr√°fico de barras no modal de relat√≥rio */
            renderReportChart(history) {
                this.dom.chartContainer.innerHTML = '';
                
                if (history.budget.length === 0) {
                    this.dom.chartContainer.innerHTML = "<p>Nenhum dado para exibir. Avance pelo menos um m√™s.</p>";
                    return;
                }
                
                const maxBudget = Math.max(...history.budget, 1);
                const maxWaste = Math.max(...history.waste, 50);
                const maxSustain = 100;

                for (let i = 0; i < history.budget.length; i++) {
                    const monthWrapper = document.createElement('div');
                    monthWrapper.className = 'c-chart-bar-wrapper';

                    const createBar = (className, value, maxValue, label) => {
                        const bar = document.createElement('div');
                        bar.className = `c-chart-bar c-chart-bar--${className}`;
                        bar.style.height = `${Helpers.clamp((value / maxValue) * 100, 5, 100)}%`; 
                        bar.title = `${label}: ${value.toFixed(0)}`;
                        bar.innerHTML = `<span class="c-chart-bar__value">${value.toFixed(0)}</span>`;
                        return bar;
                    };
                    
                    monthWrapper.appendChild(createBar('budget', history.budget[i], maxBudget, 'Or√ßamento'));
                    monthWrapper.appendChild(createBar('sustainability', history.sustainability[i], maxSustain, 'Sustentabilidade'));
                    monthWrapper.appendChild(createBar('waste', history.waste[i], maxWaste, 'Desperd√≠cio'));

                    const label = document.createElement('span');
                    label.className = 'c-chart-bar__label';
                    label.textContent = `M√™s ${i + 1}`;
                    monthWrapper.appendChild(label);
                    
                    this.dom.chartContainer.appendChild(monthWrapper);
                }
            }
            
            /** Renderiza a tela final */
            renderEndScreen(state, finalMessage, isWin) {
                this.renderStats(state, this.dom.finalStatsGrid);
                this.dom.finalMessage.textContent = finalMessage;
                this.dom.finalMessage.className = '';
                this.dom.finalMessage.classList.add(isWin ? 'u-text-success' : 'u-text-danger');
                
                this.switchScreen('end');
                this.toggleMusic(false); // Pausa a m√∫sica
            }
        }
        
        
        /* ==========================================================================
           VIRTUAL FILE: /js/modules/ProfessorSabia.js
           DESCRI√á√ÉO: A "IA" do mentor.
                      L√™ o estado e decide qual dica ou pergunta fazer.
           ========================================================================== */
        
        // PROFESSOR SABI√Å: 
        // Esta √© a minha classe, meu "c√©rebro".
        // Meu trabalho √©:
        // 1. Olhar o 'state' e ver se voc√™ precisa de ajuda (ex: 'state.budget < 500').
        // 2. Se precisar, eu chamo 'ui.updateSabiaTip(...)' para te avisar.
        // 3. De vez em quando, eu chamo 'ui.showSabiaQuizModal(...)' para
        //    fazer uma pergunta sobre o c√≥digo.
        
        class ProfessorSabia {
            constructor(ui) {
                this.ui = ui; // Recebe a UI para poder control√°-la
                this.lastQuizMonth = -1;
            }
            
            /** Loga uma mensagem no console com o estilo do Sabi√° */
            log(message, type = 'sabia') {
                const s = `<strong>Professor Sabi√°:</strong> "${message}"`;
                this.ui.addLog(s, type);
            }
            
            /** Mensagem de boas-vindas */
            greet(playerName, profileName) {
                this.log(`Ol√°, ${playerName}! Um ${profileName}, hein? Uma escolha audaciosa! Sua jornada na EcoF√°brica come√ßa agora. Estou aqui para ajudar!`);
            }
            
            /** Analisa o estado e d√° uma dica contextual */
            giveContextualTip(state) {
                let tipToShow = "As coisas parecem est√°veis. Continue com o bom planejamento!";
                let tipTitle = "Relat√≥rio do Professor Sabi√°";
                
                // Procura por uma dica de "problema" primeiro
                const problemTip = SABIA_KNOWLEDGE_BASE.gameTips.find(tip => {
                    return tip.condition(state);
                });
                
                if (problemTip) {
                    tipToShow = problemTip.tip;
                    tipTitle = "ü¶â Alerta do Professor Sabi√°!";
                } else {
                    // Se n√£o houver problema, pega uma dica gen√©rica
                    const genericTips = [
                        "N√£o se esque√ßa de investir em P&D! O conhecimento de hoje √© o lucro de amanh√£.",
                        "Manter a Moral da Equipe alta resulta em mais Pontos de P&D passivos.",
                        "Reputa√ß√£o alta pode aumentar o pre√ßo dos seus produtos. Fique de olho!",
                        "Desperd√≠cio n√£o √© s√≥ ruim para o planeta, ele gera custos diretos todo m√™s!"
                    ];
                    tipToShow = Helpers.getRandomItem(genericTips);
                    tipTitle = "ü¶â Dica do Professor Sabi√°";
                }
                
                this.ui.updateSabiaTip(tipTitle, tipToShow);
            }
            
            /** Decide se √© hora de fazer uma pergunta do quiz */
            attemptToAskQuiz(state, gameInstance) {
                if (state.currentMonth <= 1 || state.isEventActive) return;
                
                // S√≥ faz uma pergunta a cada 2 meses (e 30% de chance)
                if (state.currentMonth > this.lastQuizMonth + 1 && Math.random() < 0.3) {
                    this.lastQuizMonth = state.currentMonth;
                    
                    const question = Helpers.getRandomItem(SABIA_KNOWLEDGE_BASE.quizQuestions);
                    if (question) {
                        this.log("Vamos fazer uma pausa r√°pida para testar seu conhecimento de c√≥digo!");
                        
                        this.ui.showSabiaQuizModal(question, (isCorrect) => {
                            gameInstance.handleQuizResult(isCorrect);
                        });
                    }
                }
            }
            
            /** Loga o resultado do quiz */
            logQuizResult(isCorrect) {
                if (isCorrect) {
                    this.log("Parab√©ns, resposta correta! Voc√™ ganhou +3 Pontos de P&D como b√¥nus!", 'good');
                } else {
                    this.log("Quase! Mas n√£o se preocupe, o importante √© aprender. Continue estudando o c√≥digo!", 'bad');
                }
            }
        }


        /* ==========================================================================
           VIRTUAL FILE: /js/core/Game.js
           DESCRI√á√ÉO: O "Motor" central do Jogo (Controlador).
                      Orquestra o State, a UI e os M√≥dulos.
           ========================================================================== */
        
        // PROFESSOR SABI√Å: 
        // Esta √© a classe 'Game', o "Maestro" da orquestra.
        // √â o "Controlador" (o 'C' do MVC).
        
        // Ela n√£o sabe *como* desenhar a tela (isso √© trabalho da UI).
        // Ela n√£o sabe *como* calcular o lucro (isso √© trabalho do State).
        
        // O trabalho dela √© coordenar tudo.
        
        class Game {
            constructor() {
                this.state = new GameState();
                this.ui = new GameUI();
                this.sabia = new ProfessorSabia(this.ui);
                
                this.isEventActive = false;
            }
            
            /** Inicia o jogo, liga os listeners */
            init() {
                this.ui.bindEvents(this);
                this.ui.switchScreen('start');
            }
            
            /** Chamado pelo bot√£o 'Start' */
            startGame(playerName, profileId) {
                this.state.initialize(playerName, profileId);
                
                const s = this.state.get();
                const profileName = GAME_DATA.profiles[s.managerProfile].name;
                
                this.ui.switchScreen('game');
                this.ui.toggleMusic(true);
                this.sabia.greet(s.playerName, profileName);
                
                // Avan√ßa para o M√™s 1
                this.advanceMonth(true);
            }
            
            /** O "Game Loop" principal */
            advanceMonth(isFirstMonth = false) {
                if (this.isEventActive) return;
                
                // 1. Processa os c√°lculos do m√™s
                if (!isFirstMonth) {
                    const summary = this.state.processMonthlyTurn();
                    this.ui.addLog(`M√™s fechado. Receita: ${Helpers.formatCurrency(summary.income)}, Custos: ${Helpers.formatCurrency(summary.expenses)}. Lucro/Preju√≠zo: ${Helpers.formatCurrency(summary.profit)}.`, 'neutral');
                } else {
                    this.state.currentMonth = 1;
                }
                
                // 2. Verifica condi√ß√µes de Fim de Jogo
                const s = this.state.get();
                if (s.budget <= 0) {
                    this.endGame(true); // Fal√™ncia
                    return;
                }
                if (s.currentMonth > GAME_DATA.totalMonths) {
                    this.endGame(false); // Fim do tempo
                    return;
                }
                
                // 3. Verifica Eventos Aleat√≥rios
                const event = this.state.checkForRandomEvent();
                if (event) {
                    this.isEventActive = true;
                    this.ui.showEventModal(event, (choiceIndex) => {
                        this.handleEventChoice(event, choiceIndex);
                    });
                    this.ui.addLog(`EVENTO: ${event.title}`, 'bad');
                }

                // 4. Renderiza a UI com o novo estado
                this.ui.render(s, this.state.history, this.isEventActive);
                
                // 5. Professor Sabi√° d√° sua dica do m√™s
                this.sabia.giveContextualTip(s);
                
                // 6. Professor Sabi√° tenta fazer um Quiz
                if (!this.isEventActive) {
                    this.sabia.attemptToAskQuiz(s, this);
                }
            }
            
            /** Chamado pela UI quando uma A√ß√£o √© clicada */
            handleAction(actionId) {
                if (this.isEventActive) return;
                
                const action = GAME_DATA.actions[actionId];
                if (!action) return;
                
                this.state.applyItemEffects(action);
                this.ui.addLog(`A√ß√£o realizada: ${action.label} (Custo: ${Helpers.formatCurrency(action.cost || 0)})`, 'good');
                this.ui.render(this.state.get(), this.state.history, this.isEventActive);
            }
            
            /** Chamado pela UI quando uma P&D √© clicada */
            handleResearch(techId) {
                if (this.isEventActive) return;

                const tech = GAME_DATA.researchTree[techId];
                if (!tech) return;
                
                this.state.applyItemEffects(tech);
                this.ui.addLog(`Pesquisa conclu√≠da: ${tech.label} (Custo: ${tech.costRP} P&D)`, 'good');
                this.ui.render(this.state.get(), this.state.history, this.isEventActive);
            }
            
            /** Chamado pela UI (modal) quando uma escolha de evento √© feita */
            handleEventChoice(event, choiceIndex) {
                const choice = event.choices[choiceIndex];
                if (!choice) return;
                
                // Aplica os efeitos da escolha
                this.state.applyEventChoice(choice);
                // CORRE√á√ÉO: Marca o evento como "ocorrido"
                this.state.triggerEvent(event.id); 
                
                this.ui.addLog(`Resultado do Evento: ${choice.log}`, 'neutral');
                
                // Libera o jogo
                this.isEventActive = false;
                this.ui.render(this.state.get(), this.state.history, this.isEventActive);
                
                // Tenta fazer o quiz agora que o evento acabou
                this.sabia.attemptToAskQuiz(this.state.get(), this);
            }
            
            /** Chamado pelo Sabi√° quando o quiz √© respondido */
            handleQuizResult(isCorrect) {
                if (isCorrect) {
                    this.state.currentState.researchPoints += 3;
                    this.sabia.logQuizResult(true);
                    this.ui.renderStats(this.state.get(), this.ui.dom.statsGrid);
                } else {
                    this.sabia.logQuizResult(false);
                }
            }
            
            /** Chamado pela UI para mostrar o relat√≥rio */
            showReport() {
                if (this.isEventActive) return;
                this.ui.renderReportChart(this.state.history);
                this.ui.showModal('reportModal', true);
            }

            /** Encerra o jogo e mostra a tela final */
            endGame(isBankruptcy) {
                const finalMessage = this.state.getFinalMessage(isBankruptcy);
                const didWin = !isBankruptcy && this.state.checkWinCondition();
                
                this.ui.renderEndScreen(this.state.get(), finalMessage, didWin);
            }
        }


        /* ==========================================================================
           VIRTUAL FILE: /js/main.js
           DESCRI√á√ÉO: Ponto de Entrada da Aplica√ß√£o.
           ========================================================================== */
        
        // PROFESSOR SABI√Å: 
        // E aqui... tudo come√ßa!
        // Limpo, organizado e profissional.
        // Boa sorte na sua gest√£o!
        
        const ecoGame = new Game();
        ecoGame.init();

    }); // Fim do 'DOMContentLoaded'
    </script>
</body>
</html>
